define(["jquery","underscore","backbone","config/config","modules/grid","collections/tiles","collections/tiles-data","modules/double-spring","modules/box","modules/grid-dom","modules/trackpad","modules/loader-screen","match_media","bootstrap_transition","bootstrap_collapse"],function(e,t,n,r,i,s,o,u,a,f,l,c,h){var p,d=n.View.extend({initialize:function(){p=this,app_compatible=!Modernizr.canvas||!h.mobile();if(app_compatible){e.when(s.fetch()).done(function(){o.content=s.toJSON(),p.load()}),r.mouse;var t=window.innerWidth||document.documentElement.clientWidth,n=window.innerHeight||document.documentElement.clientHeight;r.mouse.x=t/2,r.mouse.y=n/2}},load:function(){loaderScreen=new c,loaderScreen.onComplete=this.kickOff,p.onResize(),e(window).resize(p.onResize)},kickOff:function(){loaded=!0,holding=!1;var t=window.innerWidth||document.documentElement.clientWidth,n=window.innerHeight||document.documentElement.clientHeight;app_compatible&&(canvas=document.getElementById("nbn"),canvas.width=t,canvas.height=n*.87,context=canvas.getContext("2d"),canvas.style.left="0px",canvas.style.display="none",e(canvas).fadeIn("slow"),e(canvas).mousedown(p.onMouseDown),e(canvas).mouseup(p.onMouseUp),e(canvas).mousemove(p.onMouseMove),e(canvas).mouseout(p.onMouseOut),e(canvas).bind("touchstart",p.onTouchStart),e(canvas).bind("touchend",p.onTouchEnd),e(canvas).bind("touchmove",p.onTouchMove),grid=new i(t,n),grid.canvasOffset=n*.08,trackpad=new l(canvas)),grid.onTransitionFinished=function(){loaderScreen.destroy(),document.body.removeChild(loaderScreen.view)},p.onResize(),p.resizeCount=9,requestAnimFrame(p.update)},onGridStartComplete:function(){p.browseMode=!0,setTimeout(p.unlock,1e3)},unlock:function(){trackpad.unlock()},update:function(){p.resizeCount++,p.resizeCount==10&&p.realResize(),grid.renderDisabled||grid.render(context),requestAnimFrame(p.update)},realResize:function(){console.log("REAL RESIZE");var e=window.innerWidth||document.documentElement.clientWidth,t=window.innerHeight||document.documentElement.clientHeight;if(window.grid){window.canvas&&(canvas.width=e,canvas.height=t*.87,grid.canvasOffset=t*.08),console.log(canvas.width+"x"+canvas.height+" offset="+grid.canvasOffset),grid.resize(e,t);var n={x:500,y:500}}},onSwapPressed:function(){window.location.hash="",p.pauseGridRender=!1,viewer.swap()},onViewerHidden:function(){trackpad.unlock(),grid.unlock(),p.browseMode=!0},onResize:function(){p.resizeCount=0;var e=window.innerWidth||document.documentElement.clientWidth,t=window.innerHeight||document.documentElement.clientHeight;this.w=e,this.h=t},onMouseDown:function(e){e.preventDefault(),r.mouse.button=!0,r.mouse.dragDistance=0},onMouseUp:function(e){e.preventDefault(),r.mouse.button=!1,r.mouse.dragDistance<15&&grid.sentClick()},onMouseOut:function(e){e.preventDefault(),r.mouse.button=!1},onTouchStart:function(e){e.preventDefault(),grid.mousefollow.x=e.originalEvent.touches[0].clientX,grid.mousefollow.y=e.originalEvent.touches[0].clientY,r.mouse.x=e.originalEvent.touches[0].clientX,r.mouse.y=e.originalEvent.touches[0].clientY,r.mouse.button=!0,r.mouse.dragDistance=0},onTouchEnd:function(e){e.preventDefault(),r.mouse.button=!1,r.mouse.dragDistance<15&&grid.sentClick()},onTouchMove:function(e){e.preventDefault();var t=e.originalEvent.touches[0].clientX+document.body.scrollLeft,n=e.originalEvent.touches[0].clientY+document.body.scrollTop,i=r.mouse.x-t,s=r.mouse.y-n;r.mouse.dragDistance+=Math.sqrt(i*i+s*s),r.mouse.dragDistance>1e4&&(r.mouse.dragDistance=1e4),r.mouse.x=t,r.mouse.y=n},onMouseMove:function(e){var t=e.clientX+document.body.scrollLeft,n=e.clientY+document.body.scrollTop;r.newX=t;var i=r.mouse.x-t,s=r.mouse.y-n;r.mouse.dragDistance+=Math.sqrt(i*i+s*s),r.mouse.dragDistance>1e4&&(r.mouse.dragDistance=1e4),r.mouse.x=t,r.mouse.y=n}});return d});