define(["jquery"],function(e){var t,n=function(n,r,i){t=this,this.ctx,this.boxes=[],this.height,this.width=90,this.left=0,this.top=0,this.padding=0,this.margin=0,this.right,this.bottom,this.content,this.contentType="text",this.properties,this.fontStyle="normal",this.fontSize=24,this.fontName="Helvetica W01 Light",this.lineHeight=this.fontSize,this.fontColour="#AADDFF",this.backgroundColour="rgba(0,0,0,.1)",this.id="",this.align="left",e.each(i,function(e,n){t[e]=n}),this.contentType=="container"&&(this.boxes=r);if(this.contentType=="text"||this.contentType=="image")this.content=r;this.ctx=n};return n.constructor=n,n.prototype.update=function(e,t){},n.prototype.last=function(){return typeof this.boxes=="undefined"?{right:0,bottom:0}:this.boxes.length==0?{right:0,bottom:0}:{right:this.boxes[this.boxes.length-1].right,bottom:this.boxes[this.boxes.length-1].bottom}},n.prototype.addBox=function(e){typeof this.boxes!="undefined"&&this.boxes.push(e)},n.prototype.splitText=function(e,t,n){var r=n.split(" "),i=[],s=r[0],o=e.measureText(r[0]).width,u=0;for(var a=1;a<r.length;a++)if(r[a].length>0){u=e.measureText(s+r[a]).width,u<t?(s+=" "+r[a],o=u):(i.push({width:o,text:s}),s=r[a],o=e.measureText(r[a]).width);if(a==r.length-1){i.push({width:o,text:s});break}}return r.length<=1&&(o=e.measureText(r[0]).width,i.push({width:o,text:r[0]})),i},n.prototype.render=function(e,t,n,r){var i,s,o;for(var u=0;u<this.boxes.length;u++){if(this.boxes[u].contentType=="text"){e.fillStyle=this.boxes[u].backgroundColour,e.fillRect(t+this.boxes[u].boxLeft*r,n+this.boxes[u].boxTop*r,this.boxes[u].boxWidth*r,this.boxes[u].boxHeight*r);if(r>.01&&this.boxes[u].content.length>0){e.fillStyle=this.boxes[u].fontColour,e.font=this.boxes[u].fontStyle+" "+this.boxes[u].fontSize+"px "+this.boxes[u].fontName,e.textBaseline="top",s=n+(this.boxes[u].drawTop+(this.boxes[u].drawHeight-this.boxes[u].lineHeight*this.boxes[u].splitLines.length)*.5)*r,r!=1&&e.scale(r,r);for(o=0;o<this.boxes[u].splitLines.length;o++)i=t+this.boxes[u].drawLeft*r,this.boxes[u].align=="center"&&(i=t+(this.boxes[u].drawLeft+(this.boxes[u].drawWidth-this.boxes[u].splitLines[o].width)*.5)*r),this.boxes[u].align=="right"&&(i=t+(this.boxes[u].drawLeft+this.boxes[u].drawWidth-this.boxes[u].splitLines[o].width)*r),e.fillText(this.boxes[u].splitLines[o].text,i/r,s/r),s+=this.boxes[u].lineHeight*r;r!=1&&e.scale(1/r,1/r)}}this.boxes[u].contentType=="image"&&(e.fillStyle=this.boxes[u].backgroundColour,e.fillRect(t+this.boxes[u].boxLeft*r,n+this.boxes[u].boxTop*r,this.boxes[u].boxWidth*r,this.boxes[u].boxHeight*r),e.drawImage(this.boxes[u].content,t+this.boxes[u].drawLeft*r,n+this.boxes[u].drawTop*r,this.boxes[u].drawWidth*r,this.boxes[u].drawHeight*r))}},n.prototype.calculate=function(){var e,t,n,r,i,s,o,u,a,f;if(this.contentType=="container"){this.right=this.left+this.width,this.bottom=this.top+this.height;for(o=0;o<this.boxes.length;o++){if(this.boxes[o].contentType=="image"){typeof this.boxes[o].width=="undefined"&&(this.boxes[o].width=this.boxes[o].content.width*100/this.width),typeof this.boxes[o].height=="undefined"&&(this.boxes[o].height=this.boxes[o].content.height*100/this.height),this.boxes[o].width=="original"&&(this.boxes[o].width=this.boxes[o].content.width*100/this.width),this.boxes[o].height=="original"&&(this.boxes[o].height=this.boxes[o].content.height*100/this.height),this.boxes[o].boxLeft=(this.boxes[o].margin+this.boxes[o].left)*this.width*.01,this.boxes[o].boxTop=(this.boxes[o].margin+this.boxes[o].top)*this.height*.01,this.boxes[o].boxWidth=(this.boxes[o].width-this.boxes[o].padding*2)*this.width*.01,this.boxes[o].boxHeight=(this.boxes[o].height-this.boxes[o].padding*2)*this.height*.01;var l=this.boxes[o].boxWidth,c=this.boxes[o].boxHeight,h=this.boxes[o].content.width/this.boxes[o].content.height,p=l/c,d,v;h>p?(d=l,v=d/h):(v=c,d=h*v),this.boxes[o].drawHeight=v,this.boxes[o].drawWidth=d,this.boxes[o].drawLeft=(this.boxes[o].margin+this.boxes[o].left+this.boxes[o].padding)*this.width*.01+(this.boxes[o].boxWidth-d)/2,this.boxes[o].drawTop=(this.boxes[o].margin+this.boxes[o].top+this.boxes[o].padding)*this.height*.01}this.boxes[o].contentType=="text"&&(this.ctx.font=this.boxes[o].fontStyle+" "+this.boxes[o].fontSize+"px "+this.boxes[o].fontName,this.ctx.textBaseline="top",this.boxes[o].drawWidth=(this.boxes[o].width-this.boxes[o].padding*2)*this.width*.01,this.boxes[o].splitLines=this.splitText(this.ctx,this.boxes[o].drawWidth,this.boxes[o].content),typeof this.boxes[o].height=="undefined"&&(this.boxes[o].splitLines.length<=1?this.boxes[o].height=this.boxes[o].fontSize*100/this.height+this.boxes[o].padding*2:this.boxes[o].height=(this.boxes[o].splitLines.length-1)*this.boxes[o].lineHeight*100/this.height+this.boxes[o].padding*2),this.boxes[o].boxLeft=(this.boxes[o].margin+this.boxes[o].left)*this.width*.01,this.boxes[o].boxTop=(this.boxes[o].margin+this.boxes[o].top)*this.height*.01,this.boxes[o].boxWidth=(this.boxes[o].width-this.boxes[o].padding*2)*this.width*.01,this.boxes[o].boxHeight=(this.boxes[o].height-this.boxes[o].padding*2)*this.height*.01,this.boxes[o].drawLeft=(this.boxes[o].margin+this.boxes[o].left+this.boxes[o].padding)*this.width*.01,this.boxes[o].drawTop=(this.boxes[o].margin+this.boxes[o].top+this.boxes[o].padding)*this.height*.01,this.boxes[o].drawHeight=this.boxes[o].splitLines.length*this.boxes[o].lineHeight),this.boxes[o].right=this.boxes[o].margin+this.boxes[o].left+this.boxes[o].width,this.boxes[o].bottom=this.boxes[o].margin+this.boxes[o].top+this.boxes[o].height}}},n});