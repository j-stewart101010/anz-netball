define(["jquery","config/config","collections/tiles-data","modules/grid-button","modules/double-spring","modules/box","views/video-embed","bootstrap_transition","bootstrap_modal"],function(e,t,n,r,i,s,o){var u,a=function(r,i){u=this,console.log("Grid"),this.camera={x:0,y:0,momentumx:0,momentumy:0},this.mousefollow={x:t.mouse.x,y:t.mouse.y},this.recalculateinterval=0,this.canvasOffset=0,this.squareWidth=306,this.squareHeight=306,this.resize(r,i),e(document).on("hidden.bs.modal",this.closedModal),this.offScreen=document.createElement("canvas"),this.offScreen.width=this.squareWidth*2,this.offScreen.height=this.squareHeight*2,this.offScreenCtx=this.offScreen.getContext("2d"),this.zoom=.2,this.defaultZoom=.6+canvas.width/1e4,this.minZoom=.3,this.dampZoom=.003,this.zoomPos={x:canvas.width/2,y:canvas.height/2},u.flippedVideoTile=0,this.lastButton=0,this.mouseHoverIndex=-1,this.mouseHoverWorldX=0,this.mouseHoverWorldY=0,this.mouseHoverTileX=0,this.mouseHoverTileY=0,this.centering=0,this.centerX=0,this.centerY=0,this.centerSize=0,this.centerZoom=1,this.dragDisabled=0,this.renderDisabled=!1;for(var o=0;o<n.content.length;o++){switch(n.content[o].tiletype){case"text":case"textlink":console.log(n.content[o]),n.content[o].box=new s(this.offScreenCtx,[],{width:this.squareWidth,height:this.squareHeight,contentType:"container"}),n.content[o].box.addBox(new s(this.offScreenCtx,"",{width:100,height:100,contentType:"text",backgroundColour:n.content[o].colour})),n.content[o].box.addBox(new s(this.offScreenCtx,n.content[o].title,{left:10,width:80,height:25,top:10,padding:0,fontSize:35,lineHeight:40,contentType:"text",align:"center"})),n.content[o].box.addBox(new s(this.offScreenCtx,n.content[o].subtext,{left:10,width:80,height:25,top:35,padding:0,fontSize:15,lineHeight:17,contentType:"text",align:"center"})),n.content[o].box.calculate(),n.content[o].box.addBox(new s(this.offScreenCtx,n.content[o].image,{width:100,top:60,left:0,align:"center",contentType:"image",id:"button"})),n.content[o].box.calculate(),console.log("text/textlink"),console.log(n.content[o].box);break;case"image":n.content[o].box=new s(this.offScreenCtx,[],{width:this.squareWidth,height:this.squareHeight,contentType:"container"}),n.content[o].box.addBox(new s(this.offScreenCtx,n.content[o].image,{width:100,height:100,contentType:"image"})),n.content[o].box.calculate(),console.log("image"),console.log(n.content[o].box),n.content[o].backbox=new s(this.offScreenCtx,[],{width:this.squareWidth,height:this.squareHeight,contentType:"container"}),n.content[o].backbox.addBox(new s(this.offScreenCtx,"",{width:100,height:100,contentType:"text",backgroundColour:n.content[o].backcolour})),n.content[o].backbox.addBox(new s(this.offScreenCtx,n.content[o].storyimage,{top:25,left:5,width:13,height:13,contentType:"image"})),n.content[o].backbox.addBox(new s(this.offScreenCtx,n.content[o].storyusername,{top:25,left:21,width:60,height:20,textunderlay:"fit",padding:.9,fontSize:10,fontstyle:"bold",contentType:"text",align:"left"})),n.content[o].backbox.calculate(),n.content[o].backbox.addBox(new s(this.offScreenCtx,n.content[o].storyfullname,{top:n.content[o].backbox.last().bottom,left:21,width:60,height:20,textunderlay:"fit",padding:.9,fontSize:7,contentType:"text",align:"left"})),n.content[o].backbox.calculate(),n.content[o].backbox.addBox(new s(this.offScreenCtx,n.content[o].storyuserinfo,{top:n.content[o].backbox.last().bottom,left:21,width:60,height:20,textunderlay:"fit",padding:.9,fontSize:7,contentType:"text",align:"left"})),n.content[o].backbox.calculate(),n.content[o].backbox.addBox(new s(this.offScreenCtx,n.content[o].storydescription,{top:n.content[o].backbox.last().bottom,left:21,width:60,height:20,textunderlay:"fit",padding:1.2,fontSize:12,contentType:"text",align:"left"})),n.content[o].backbox.calculate(),n.content[o].backbox.addBox(new s(this.offScreenCtx,n.content[o].storytags,{top:n.content[o].backbox.last().bottom,left:21,width:60,height:20,textunderlay:"fit",padding:1.2,fontSize:9,contentType:"text",align:"left"})),n.content[o].backbox.calculate(),console.log("image backbox"),console.log(n.content[o].backbox);break;case"video":n.content[o].box=new s(this.offScreenCtx,[],{width:this.squareWidth,height:this.squareHeight,contentType:"container"}),n.content[o].box.addBox(new s(this.offScreenCtx,n.content[o].image,{width:100,height:100,contentType:"image"})),n.content[o].box.addBox(new s(this.offScreenCtx,"",{width:100,height:100,contentType:"text",backgroundColour:"rgba(70,145,185,0.11)"})),n.content[o].box.addBox(new s(this.offScreenCtx,"VIDEO",{contentType:"text",fontStyle:"bold",left:8.5,top:10,width:80,height:25,padding:2,fontSize:9,backgroundColour:"rgba(0,0,0,0.35)",textunderlay:"fit"})),n.content[o].box.calculate(),n.content[o].box.addBox(new s(this.offScreenCtx,n.content[o].textname,{contentType:"text",left:n.content[o].box.last().right,top:10,width:80,height:25,padding:2,fontSize:9,backgroundColour:"rgba(0,0,0,0.35)",textunderlay:"fit"})),n.content[o].box.addBox(new s(this.offScreenCtx,n.content[o].textsubject,{contentType:"text",left:8.5,top:20,width:80,height:20,padding:2,fontSize:22,backgroundColour:"rgba(0,0,0,0.35)",textunderlay:"fit"})),n.content[o].box.addBox(new s(this.offScreenCtx,n.content[o].subimage,{left:7,top:85,contentType:"image",width:20,height:8})),n.content[o].box.calculate(),console.log("video"),console.log(n.content[o].box),n.content[o].backbox=new s(this.offScreenCtx,[],{width:this.squareWidth,height:this.squareHeight,contentType:"container"}),n.content[o].backbox.addBox(new s(this.offScreenCtx,"",{width:100,height:100,contentType:"text",backgroundColour:"rgb(0,0,0)"})),n.content[o].backbox.calculate()}n.content[o].flipProgress=0,n.content[o].flipDirection=0,n.content[o].scaleProgress=0,n.content[o].scaleDirection=0,n.content[o].actionX=0,n.content[o].actionY=0}};return a.constructor=a,a.prototype.resize=function(e,t){this.defaultZoom=.6+e/1e4,this.width=e,this.height=t,this.zoomPos={x:e/2,y:t/2}},a.prototype.closedModal=function(){console.log("unflipped "+u.flippedVideoTile),n.content[u.flippedVideoTile].flipDirection=-0.027},a.prototype.sentClick=function(){var e=this.mouseHoverIndex;if(e<0)return;console.log(this.mouseHoverWorldX+","+this.mouseHoverWorldY);if(n.content[e].flippable){if(n.content[e].tiletype=="image"){console.log("i:"+e+": "+"ScaleDirecshn:"+n.content[e].scaleDirection+" FlipDirecshn:"+n.content[e].flipDirection),console.log("ScaleProgress:"+n.content[e].scaleProgress+" FlipProgress:"+n.content[e].scaleProgress);if(n.content[e].scaleProgress==1||n.content[e].scaleDirection>0){if(n.content[e].flipProgress==1&&n.content[e].scaleProgress==1)n.content[e].flipDirection=-0.027,n.content[e].scaleDirection=-0.027,console.log("scale downward and flip back"),n.content[e].actionX=this.mouseHoverWorldX,n.content[e].actionY=this.mouseHoverWorldY;else if(n.content[e].flipProgress==0||n.content[e].flipDirection<0)console.log("flip forward"),n.content[e].flipDirection=.027,n.content[e].actionX=this.mouseHoverWorldX,n.content[e].actionY=this.mouseHoverWorldY}else if(n.content[e].scaleProgress==0||n.content[e].scaleDirection<0)if(n.content[e].flipProgress==0||n.content[e].flipDirection<0)n.content[e].scaleDirection=.027,n.content[e].actionX=this.mouseHoverWorldX,n.content[e].actionY=this.mouseHoverWorldY}if(n.content[e].tiletype=="video"){if(n.content[e].flipProgress==1||n.content[e].flipDirection>0)n.content[e].flipDirection=-0.027,n.content[e].actionX=this.mouseHoverWorldX,n.content[e].actionY=this.mouseHoverWorldY;if(n.content[e].flipProgress==0||n.content[e].flipDirection<0)n.content[e].flipDirection=.027,n.content[e].actionX=this.mouseHoverWorldX,n.content[e].actionY=this.mouseHoverWorldY,this.dragDisabled=36,this.centering=720,this.centerX=this.mouseHoverWorldX,this.centerY=this.mouseHoverWorldY,this.centerSize=500,this.centerZoom=this.centerSize/(model.content[e].scale*this.squareWidth)}for(var t=0;t<n.content.length;t++)t!=e&&(n.content[t].scaleProgress>0&&(n.content[t].scaleDirection=-0.108),n.content[t].flipProgress>0&&(n.content[t].flipDirection=-0.108))}},a.prototype.onFlip=function(t){n.content[t].tiletype=="video"&&(u.flippedVideoTile=t,e("body").append((new o({modal:!0,video_id:n.content[t].videoid})).render().el))},a.prototype.onUnFlip=function(e){},a.prototype.onScale=function(e){},a.prototype.onUnScale=function(e){},a.prototype.drawImagePerspective=function(e,t,n,r,i,s,o,u){var a=-t*.5*Math.cos(u*Math.PI/180),f=-n*.13*Math.sin(u*Math.PI/180),l=-2*a*o/t,c=-2*o*f/t,h=-2*c,p=i+(t*.5+a)*o,d=s+f*o,v=(n-2*f)*o;for(var m=0;m<t;m++)r.drawImage(e.canvas,l>0?m:t-m-1,0,1,n-1,Math.floor(p),Math.floor(d),Math.ceil(o),v),p+=l,d+=c,v+=h},a.prototype.render=function(e){e.save(),this.recalculateinterval++,this.recalculateinterval%=360;if(this.recalculateinterval==0)for(var r=0;r<n.content.length;r++)n.content[r].box.calculate();this.mousefollow.x+=(t.mouse.x-this.mousefollow.x)*.4,this.mousefollow.y+=(t.mouse.y-this.mousefollow.y)*.4,!this.dragDisabled&&t.mouse.button&&(this.camera.momentumx=(this.mousefollow.x-t.mouse.x)*.4,this.camera.momentumy=(this.mousefollow.y-t.mouse.y)*.4),this.dragDisabled>0&&this.dragDisabled--,this.camera.x+=this.camera.momentumx/this.zoom,this.camera.y+=this.camera.momentumy/this.zoom,Math.abs(this.camera.momentumx)<.3&&(this.camera.momentumx=0,this.camera.x=Math.round(this.camera.x)),Math.abs(this.camera.momentumy)<.3&&(this.camera.momentumy=0,this.camera.y=Math.round(this.camera.y));var i;if(this.centering>0){this.centering--,i=this.centerZoom;var s=this.centerX+(this.centerSize*.5-canvas.width*.5)/this.centerZoom,o=this.centerY+(this.centerSize*.5-canvas.height*.5)/this.centerZoom;this.camera.x+=(s-this.camera.x)*.1,this.camera.y+=(o-this.camera.y)*.1}else i=this.defaultZoom-Math.pow(this.camera.momentumx*this.camera.momentumx+this.camera.momentumy*this.camera.momentumy,.4)/70,this.camera.momentumx*=.97,this.camera.momentumy*=.97;i<.2&&(i=.2),this.zoom+=(i-this.zoom)*this.dampZoom,this.dampZoom+=.004,this.dampZoom>.2&&(this.dampZoom=.2),Math.abs(1-this.zoom)<.01&&(this.zoom=1),this.lastButton=t.mouse.button;var u,a,f,l,c=n.worldWidth*this.squareWidth,h=5*this.squareHeight;e.fillStyle="#004165",e.fillRect(0,0,canvas.width,canvas.height);for(r=0;r<n.content.length;r++){n.content[r].scaleProgress+=n.content[r].scaleDirection,n.content[r].scaleProgress>1&&(n.content[r].scaleProgress=1,n.content[r].scaleDirection=0,this.onScale(r)),n.content[r].scaleProgress<0&&(n.content[r].scaleProgress=0,n.content[r].scaleDirection=0,this.onUnScale(r)),n.content[r].flipProgress+=n.content[r].flipDirection,n.content[r].flipProgress>1&&(n.content[r].flipProgress=1,n.content[r].flipDirection=0,this.onFlip(r)),n.content[r].flipProgress<0&&(n.content[r].flipProgress=0,n.content[r].flipDirection=0,this.onUnFlip(r)),u=-Math.floor(this.camera.x),f=Math.floor(Math.floor(this.camera.x)/c)*c,u>0&&(f+=c),u%=c,u-=c*Math.ceil(canvas.width/(c*this.zoom*2)),f-=c*Math.ceil(canvas.width/(c+this.squareWidth*this.zoom*2)),u+=n.content[r].position.x*this.squareWidth,f+=n.content[r].position.x*this.squareWidth,a=-Math.floor(this.camera.y),l=Math.floor(Math.floor(this.camera.y)/h)*h,a>0&&(l+=h),a%=h,a-=h*Math.ceil(canvas.height/(h*this.zoom*2)),l-=h*Math.ceil(canvas.height/(h*this.zoom*2)),a+=n.content[r].position.y*this.squareHeight,l+=n.content[r].position.y*this.squareHeight;var p,d=(a-this.zoomPos.y)*this.zoom+this.zoomPos.y,v,m,g=l;do{p=(u-this.zoomPos.x)*this.zoom+this.zoomPos.x,m=f;do{if(n.content[r].scaleProgress==0||n.content[r].actionX!=f||n.content[r].actionY!=l)n.content[r].flipProgress==0&&n.content[r].box.render(e,p,d,this.zoom*n.content[r].scale),n.content[r].flipProgress==1&&n.content[r].backbox.render(e,p,d,this.zoom*n.content[r].scale);t.mouse.x>=p&&t.mouse.x<p+n.content[r].scale*this.squareWidth*this.zoom&&t.mouse.y-this.canvasOffset>=d&&t.mouse.y-this.canvasOffset<d+n.content[r].scale*this.squareHeight*this.zoom&&(e.fillStyle="rgba(0,0,0,.35)",e.fillRect(p,d,n.content[r].scale*this.squareWidth*this.zoom,n.content[r].scale*this.squareWidth*this.zoom),this.mouseHoverIndex=r,this.mouseHoverWorldX=m,this.mouseHoverWorldY=g,this.mouseHoverTileX=(t.mouse.x-p)/this.zoom,this.mouseHoverTileY=(t.mouse.y-this.canvasOffset-d)/this.zoom),p+=c*this.zoom,m+=c}while(p<=canvas.width);d+=h*this.zoom,g+=h}while(d<=canvas.height)}for(r=0;r<n.content.length;r++){u=-Math.floor(this.camera.x),f=Math.floor(Math.floor(this.camera.x)/c)*c,u>0&&(f+=c),u%=c,u-=c*Math.ceil(canvas.width/(c*this.zoom*2)),f-=c*Math.ceil(canvas.width/(c+this.squareWidth*this.zoom*2)),u+=n.content[r].position.x*this.squareWidth,f+=n.content[r].position.x*this.squareWidth,a=-Math.floor(this.camera.y),l=Math.floor(Math.floor(this.camera.y)/h)*h,a>0&&(l+=h),a%=h,a-=h*Math.ceil(canvas.height/(h*this.zoom*2)),l-=h*Math.ceil(canvas.height/(h*this.zoom*2)),a+=n.content[r].position.y*this.squareHeight,l+=n.content[r].position.y*this.squareHeight;var p,d=(a-this.zoomPos.y)*this.zoom+this.zoomPos.y,v;do{p=(u-this.zoomPos.x)*this.zoom+this.zoomPos.x;do n.content[r].scaleProgress>0&&n.content[r].actionX==m&&n.content[r].actionY==g&&(n.content[r].flipProgress==0&&n.content[r].box.render(e,p,d,this.zoom*(n.content[r].scale+n.content[r].scaleProgress)),n.content[r].flipProgress==1&&n.content[r].backbox.render(e,p,d,this.zoom*(n.content[r].scale+n.content[r].scaleProgress))),p+=c*this.zoom;while(p<=canvas.width);d+=h*this.zoom}while(d<=canvas.height)}var y;for(r=0;r<n.content.length;r++){u=-Math.floor(this.camera.x),f=Math.floor(Math.floor(this.camera.x)/c)*c,u>0&&(f+=c),u%=c,u-=c*Math.ceil(canvas.width/(c*this.zoom*2)),f-=c*Math.ceil(canvas.width/(c+this.squareWidth*this.zoom*2)),u+=n.content[r].position.x*this.squareWidth,f+=n.content[r].position.x*this.squareWidth,a=-Math.floor(this.camera.y),l=Math.floor(Math.floor(this.camera.y)/h)*h,a>0&&(l+=h),a%=h,a-=h*Math.ceil(canvas.height/(h*this.zoom*2)),l-=h*Math.ceil(canvas.height/(h*this.zoom*2)),a+=n.content[r].position.y*this.squareHeight,l+=n.content[r].position.y*this.squareHeight;var p,d=(a-this.zoomPos.y)*this.zoom+this.zoomPos.y,v;do{p=(u-this.zoomPos.x)*this.zoom+this.zoomPos.x;do n.content[r].flipProgress>0&&n.content[r].flipProgress<1&&(n.content[r].flipProgress<.5?(v=n.content[r].flipProgress*180,n.content[r].box.render(this.offScreenCtx,0,0,n.content[r].scale)):(v=n.content[r].flipProgress*180+0,n.content[r].backbox.render(this.offScreenCtx,0,0,n.content[r].scale)),this.drawImagePerspective(this.offScreenCtx,this.squareWidth*n.content[r].scale,this.squareHeight*n.content[r].scale,e,p,d,this.zoom*(1+n.content[r].scaleProgress),v)),p+=c*this.zoom;while(p<=canvas.width);d+=h*this.zoom}while(d<=canvas.height)}e.font="bold 30px Arial",e.fillStyle="white",e.fillText(Math.floor(this.camera.x)+","+Math.floor(this.camera.y),5,5),e.fillText(Math.floor(this.camera.x/c),5,30),e.restore()},a});