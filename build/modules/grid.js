define(["jquery","config/config","models/tile","modules/grid-button","modules/double-spring","modules/box","views/video-embed","bootstrap_transition","bootstrap_modal"],function(e,t,n,r,i,s,o){var u,a=function(r,i){u=this,console.log("Grid"),this.camera={x:0,y:0,momentumx:0,momentumy:0},this.mousefollow={x:t.mouse.x,y:t.mouse.y},this.recalculateinterval=0,this.canvasOffset=0,this.squareWidth=306,this.squareHeight=306,this.resize(r,i),e(document).on("hidden.bs.modal",this.closedModal),this.offScreen=document.createElement("canvas"),this.offScreen.width=this.squareWidth*2,this.offScreen.height=this.squareHeight*2,this.offScreenCtx=this.offScreen.getContext("2d"),this.zoom=.2,this.defaultZoom=.6+canvas.width/1e4,this.minZoom=.3,this.dampZoom=.01,this.zoomPos={x:canvas.width/2,y:canvas.height/2},u.flippedVideoTile=0,this.lastButton=0,this.mouseHoverIndex=-1,this.mouseHoverWorldX=0,this.mouseHoverWorldY=0,this.mouseHoverTileX=0,this.mouseHoverTileY=0;for(var o=0;o<n.content.length;o++){switch(n.content[o].tiletype){case"text":case"textlink":n.content[o].box=new s(this.offScreenCtx,[],{width:this.squareWidth,height:this.squareHeight,contentType:"container"}),n.content[o].box.addBox(new s(this.offScreenCtx,"",{width:100,height:100,contentType:"text",backgroundColour:n.content[o].colour})),n.content[o].box.addBox(new s(this.offScreenCtx,n.content[o].title,{left:10,width:80,top:10,padding:5,fontSize:35,lineHeight:40,contentType:"text",align:"center"})),n.content[o].box.addBox(new s(this.offScreenCtx,n.content[o].subtext,{left:10,width:80,top:35,padding:5,fontSize:15,lineHeight:17,contentType:"text",align:"center"})),n.content[o].box.calculate(),n.content[o].box.addBox(new s(this.offScreenCtx,n.content[o].image,{width:100,top:60,left:0,align:"center",contentType:"image",id:"button"})),n.content[o].box.calculate();break;case"image":n.content[o].box=new s(this.offScreenCtx,[],{width:this.squareWidth,height:this.squareHeight,contentType:"container"}),n.content[o].box.addBox(new s(this.offScreenCtx,n.content[o].image,{width:100,height:100,contentType:"image"})),n.content[o].box.calculate(),n.content[o].backbox=new s(this.offScreenCtx,[],{width:this.squareWidth,height:this.squareHeight,contentType:"container"}),n.content[o].backbox.addBox(new s(this.offScreenCtx,"",{width:100,height:100,contentType:"text",backgroundColour:n.content[o].backcolour})),n.content[o].backbox.addBox(new s(this.offScreenCtx,n.content[o].storyimage,{top:25,left:5,width:13,height:13,contentType:"image"})),n.content[o].backbox.addBox(new s(this.offScreenCtx,n.content[o].storyusername,{top:25,left:21,width:60,padding:0,fontSize:10,fontstyle:"bold",contentType:"text",align:"left"})),n.content[o].backbox.calculate(),n.content[o].backbox.addBox(new s(this.offScreenCtx,n.content[o].storyfullname,{top:n.content[o].backbox.last().bottom,left:21,width:60,padding:5,fontSize:7,lineHeight:40,contentType:"text",align:"left"})),n.content[o].backbox.calculate(),n.content[o].backbox.addBox(new s(this.offScreenCtx,n.content[o].storyuserinfo,{top:n.content[o].backbox.last().bottom,left:21,width:60,padding:5,fontSize:7,contentType:"text",align:"left"})),n.content[o].backbox.calculate(),n.content[o].backbox.addBox(new s(this.offScreenCtx,n.content[o].storydescription,{top:n.content[o].backbox.last().bottom,left:21,width:60,padding:5,fontSize:13,contentType:"text",align:"left"})),n.content[o].backbox.calculate(),n.content[o].backbox.addBox(new s(this.offScreenCtx,n.content[o].storytags,{top:n.content[o].backbox.last().bottom,left:21,width:80,padding:5,fontSize:10,contentType:"text",align:"left"})),n.content[o].backbox.calculate();break;case"video":n.content[o].box=new s(this.offScreenCtx,[],{width:this.squareWidth,height:this.squareHeight,contentType:"container"}),n.content[o].box.addBox(new s(this.offScreenCtx,n.content[o].image,{width:100,height:100,contentType:"image"})),n.content[o].box.addBox(new s(this.offScreenCtx,"",{width:100,height:100,contentType:"text",backgroundColour:"rgba(70,145,185,0.11)"})),n.content[o].box.addBox(new s(this.offScreenCtx,"VIDEO: "+n.content[o].textname,{contentType:"text",left:8.5,top:10,width:80,padding:5,fontSize:9,backgroundColour:"rgba(60,0,0,0.35)"})),n.content[o].box.addBox(new s(this.offScreenCtx,n.content[o].textsubject,{contentType:"text",left:8.5,top:17.5,width:80,height:20,padding:5,fontSize:22,backgroundColour:"rgba(0,60,0,0.35)"})),n.content[o].box.addBox(new s(this.offScreenCtx,n.content[o].subimage,{left:8.5,top:75,contentType:"image"})),n.content[o].box.calculate(),n.content[o].backbox=new s(this.offScreenCtx,[],{width:this.squareWidth,height:this.squareHeight,contentType:"container"}),n.content[o].backbox.addBox(new s(this.offScreenCtx,"",{width:100,height:100,contentType:"text",backgroundColour:"rgb(0,0,0)"})),n.content[o].backbox.calculate()}n.content[o].flipProgress=0,n.content[o].flipDirection=0,n.content[o].scaleProgress=0,n.content[o].scaleDirection=0,n.content[o].actionX=0,n.content[o].actionY=0}};return a.constructor=a,a.prototype.resize=function(e,t){this.defaultZoom=.6+canvas.width/1e4,this.width=e,this.height=t,this.zoomPos={x:e/2,y:t/2}},a.prototype.closedModal=function(){console.log("unflipped "+u.flippedVideoTile),n.content[u.flippedVideoTile].flipDirection=-0.027},a.prototype.sentClick=function(){var e=this.mouseHoverIndex;if(e<0)return;console.log("Clicked "+e);if(n.content[e].flippable){if(n.content[e].tiletype=="image"){console.log("i:"+e+": "+"ScaleDirecshn:"+n.content[e].scaleDirection+" FlipDirecshn:"+n.content[e].flipDirection),console.log("ScaleProgress:"+n.content[e].scaleProgress+" FlipProgress:"+n.content[e].scaleProgress);if(n.content[e].scaleProgress==1||n.content[e].scaleDirection>0){if(n.content[e].flipProgress==1&&n.content[e].scaleProgress==1)n.content[e].flipDirection=-0.027,n.content[e].scaleDirection=-0.027,console.log("scale downward and flip back"),n.content[e].actionX=this.mouseHoverWorldX,n.content[e].actionY=this.mouseHoverWorldY;else if(n.content[e].flipProgress==0||n.content[e].flipDirection<0)console.log("flip forward"),n.content[e].flipDirection=.027,n.content[e].actionX=this.mouseHoverWorldX,n.content[e].actionY=this.mouseHoverWorldY}else if(n.content[e].scaleProgress==0||n.content[e].scaleDirection<0)if(n.content[e].flipProgress==0||n.content[e].flipDirection<0)console.log("scale upward"),n.content[e].scaleDirection=.027,n.content[e].actionX=this.mouseHoverWorldX,n.content[e].actionY=this.mouseHoverWorldY}if(n.content[e].tiletype=="video"){if(n.content[e].flipProgress==1||n.content[e].flipDirection>0)n.content[e].flipDirection=-0.027,n.content[e].actionX=this.mouseHoverWorldX,n.content[e].actionY=this.mouseHoverWorldY;if(n.content[e].flipProgress==0||n.content[e].flipDirection<0)n.content[e].flipDirection=.027,n.content[e].actionX=this.mouseHoverWorldX,n.content[e].actionY=this.mouseHoverWorldY}for(var t=0;t<n.content.length;t++)t!=e&&(n.content[t].scaleProgress>0&&(n.content[t].scaleDirection=-0.027),n.content[t].flipProgress>0&&(n.content[t].flipDirection=-0.027))}},a.prototype.onFlip=function(t){n.content[t].tiletype=="video"&&(u.flippedVideoTile=t,e("body").append((new o({modal:!0,video_id:n.content[t].videoid})).render().el))},a.prototype.onUnFlip=function(e){},a.prototype.onScale=function(e){},a.prototype.onUnScale=function(e){},a.prototype.drawImagePerspective=function(e,t,n,r,i,s,o,u){var a=-t*.5*Math.cos(u*Math.PI/180),f=-n*.13*Math.sin(u*Math.PI/180),l=-2*a*o/t,c=-2*o*f/t,h=-2*c,p=i+(t*.5+a)*o,d=s+f*o,v=(n-2*f)*o;for(var m=0;m<t;m++)r.drawImage(e.canvas,l>0?m:t-m-1,0,1,n-1,p,d,Math.ceil(o),v),p+=l,d+=c,v+=h},a.prototype.render=function(e){e.save(),this.recalculateinterval++,this.recalculateinterval%=360;if(this.recalculateinterval==0){console.log("recalculate");for(var r=0;r<n.content.length;r++)n.content[r].box.calculate()}this.mousefollow.x+=(t.mouse.x-this.mousefollow.x)*.4,this.mousefollow.y+=(t.mouse.y-this.mousefollow.y)*.4,t.mouse.button&&(this.camera.momentumx=(this.mousefollow.x-t.mouse.x)*.4,this.camera.momentumy=(this.mousefollow.y-t.mouse.y)*.4),this.camera.x+=this.camera.momentumx/this.zoom,this.camera.y+=this.camera.momentumy/this.zoom,this.camera.momentumx*=.97,this.camera.momentumy*=.97,Math.abs(this.camera.momentumx)<.3&&(this.camera.momentumx=0,this.camera.x=Math.round(this.camera.x)),Math.abs(this.camera.momentumy)<.3&&(this.camera.momentumy=0,this.camera.y=Math.round(this.camera.y));var i=this.defaultZoom-Math.pow(this.camera.momentumx*this.camera.momentumx+this.camera.momentumy*this.camera.momentumy,.4)/70;i<.2&&(i=.2),this.zoom+=(i-this.zoom)*this.dampZoom,this.dampZoom+=.005,this.dampZoom>.2&&(this.dampZoom=.2),this.lastButton=t.mouse.button;var s,o,u,a,f=n.worldWidth*this.squareWidth,l=5*this.squareHeight;e.fillStyle="#004165",e.fillRect(0,0,canvas.width,canvas.height);for(r=0;r<n.content.length;r++){n.content[r].scaleProgress+=n.content[r].scaleDirection,n.content[r].scaleProgress>1&&(n.content[r].scaleProgress=1,n.content[r].scaleDirection=0,this.onScale(r)),n.content[r].scaleProgress<0&&(n.content[r].scaleProgress=0,n.content[r].scaleDirection=0,this.onUnScale(r)),n.content[r].flipProgress+=n.content[r].flipDirection,n.content[r].flipProgress>1&&(n.content[r].flipProgress=1,n.content[r].flipDirection=0,console.log(n.content[r].scale*this.squareWidth*this.zoom),this.onFlip(r)),n.content[r].flipProgress<0&&(n.content[r].flipProgress=0,n.content[r].flipDirection=0,this.onUnFlip(r)),s=Math.round(n.content[r].position.x*this.squareWidth-this.camera.x),o=Math.round(n.content[r].position.y*this.squareHeight-this.camera.y),u=Math.round(n.content[r].position.x*this.squareWidth+this.camera.x),a=Math.round(n.content[r].position.y*this.squareHeight+this.camera.y),s%=f,s<0&&(s+=f),s>=f-n.content[r].scale*this.squareWidth&&(s-=f),s-=f*Math.ceil(canvas.width/(f*this.zoom*2)),u-=f*Math.ceil(canvas.width/(f*2)),o%=l,o<0&&(o+=l),o>=l-n.content[r].scale*this.squareHeight&&(o-=l),o-=l*Math.ceil(canvas.height/(l*this.zoom*2)),a-=l*Math.ceil(canvas.height/(l*2));var c,h=(o-this.zoomPos.y)*this.zoom+this.zoomPos.y,p,d,v=a;do{c=(s-this.zoomPos.x)*this.zoom+this.zoomPos.x,d=u;do n.content[r].scaleProgress==0&&(n.content[r].flipProgress==0&&n.content[r].box.render(e,c,h,this.zoom*n.content[r].scale),n.content[r].flipProgress==1&&n.content[r].backbox.render(e,c,h,this.zoom*n.content[r].scale)),t.mouse.x>=c&&t.mouse.x<c+n.content[r].scale*this.squareWidth*this.zoom&&t.mouse.y-this.canvasOffset>=h&&t.mouse.y-this.canvasOffset<h+n.content[r].scale*this.squareHeight*this.zoom&&(e.fillStyle="rgba(0,0,0,.35)",e.fillRect(c,h,n.content[r].scale*this.squareWidth*this.zoom,n.content[r].scale*this.squareWidth*this.zoom),this.mouseHoverIndex=r,this.mouseHoverWorldX=d,this.mouseHoverWorldY=v,this.mouseHoverTileX=(t.mouse.x-c)/this.zoom,this.mouseHoverTileY=(t.mouse.y-this.canvasOffset-h)/this.zoom,e.fillStyle="green",e.beginPath(),e.arc(c+this.mouseHoverTileX*this.zoom,h+this.mouseHoverTileY*this.zoom,10,0,Math.PI*2,!0),e.closePath(),e.fill()),m=Math.floor(d/this.squareWidth),e.font="bold 40px",e.fillStyle="black",e.fillText(m,c,h),c+=f*this.zoom,d+=f;while(c<=canvas.width);h+=l*this.zoom,v+=l}while(h<=canvas.height)}for(r=0;r<n.content.length;r++){s=Math.round(n.content[r].position.x*this.squareWidth-this.camera.x),o=Math.round(n.content[r].position.y*this.squareHeight-this.camera.y),u=s,a=o,s%=f,s<0&&(s+=f),s>=f-n.content[r].scale*this.squareWidth&&(s-=f),s-=f*Math.ceil(canvas.width/(f*this.zoom*2)),o%=l,o<0&&(o+=l),o>=l-n.content[r].scale*this.squareHeight&&(o-=l),o-=l*Math.ceil(canvas.height/(l*this.zoom*2));var c,h=(o-this.zoomPos.y)*this.zoom+this.zoomPos.y,p;do{c=(s-this.zoomPos.x)*this.zoom+this.zoomPos.x;do n.content[r].scaleProgress>0&&(n.content[r].flipProgress==0&&n.content[r].box.render(e,c,h,this.zoom*(n.content[r].scale+n.content[r].scaleProgress)),n.content[r].flipProgress==1&&n.content[r].backbox.render(e,c,h,this.zoom*(n.content[r].scale+n.content[r].scaleProgress))),c+=f*this.zoom;while(c<=canvas.width);h+=l*this.zoom}while(h<=canvas.height)}var m;for(r=0;r<n.content.length;r++){s=Math.round(n.content[r].position.x*this.squareWidth-this.camera.x),o=Math.round(n.content[r].position.y*this.squareHeight-this.camera.y),u=s,a=o,s%=f,s<0&&(s+=f),s>=f-n.content[r].scale*this.squareWidth&&(s-=f),s-=f*Math.ceil(canvas.width/(f*this.zoom*2)),o%=l,o<0&&(o+=l),o>=l-n.content[r].scale*this.squareHeight&&(o-=l),o-=l*Math.ceil(canvas.height/(l*this.zoom*2));var c,h=(o-this.zoomPos.y)*this.zoom+this.zoomPos.y,p;do{c=(s-this.zoomPos.x)*this.zoom+this.zoomPos.x;do n.content[r].flipProgress>0&&n.content[r].flipProgress<1&&(n.content[r].flipProgress<.5?(p=n.content[r].flipProgress*180,n.content[r].box.render(this.offScreenCtx,0,0,n.content[r].scale)):(p=n.content[r].flipProgress*180+0,n.content[r].backbox.render(this.offScreenCtx,0,0,n.content[r].scale)),this.drawImagePerspective(this.offScreenCtx,this.squareWidth*n.content[r].scale,this.squareHeight*n.content[r].scale,e,c,h,this.zoom*(1+n.content[r].scaleProgress),p)),c+=f*this.zoom;while(c<=canvas.width);h+=l*this.zoom}while(h<=canvas.height)}e.restore()},a});